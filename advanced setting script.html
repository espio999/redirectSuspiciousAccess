<!--
<noscript>
  <meta http-equiv="refresh" content="0;URL='https://impsbl.hatenablog.jp/entry/20251231#%E4%B8%8D%E5%AF%A9%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%AEredirect%E5%85%88Redirect-Destination-for-Suspicious-Access'" />
</noscript>
-->

<noscript>
  <meta http-equiv="refresh" content="0;URL='https://0.0.0.0'" />
</noscript>

<!--ã€€SE6å¯¾å¿œã®ç¢ºèªã‚³ãƒ¼ãƒ‰ãªã®ã§ã€SR6ä»¥å‰ã®è¨˜è¿°ã‚¹ã‚¿ã‚¤ãƒ«ã§ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚ã€€-->
<script>
  var isLegacy = (function() {
    try {
      // 1. æœ€å°é™ã®ES6æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
      new Function('() => {}');

      // 2. å¿…é ˆAPIã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
      if (typeof Promise === "undefined" || !Object.assign) {
        return true;
      }
      
      return false;
    } catch (e) {
      return true;
    }
  })();

  if (isLegacy) {
    var destination_url = "https://0.0.0.0"
    window.location.replace(destination_url);
  }
</script>

<!--ã€€æœ€åˆã®æ¤œé–²ã€€-->
<script>
  function isSuspiciousQuery(){
    const suspicious_keys = new Set([
      'ad_format_ids',
      'sua',
      'gclid',
      'fbclid',   // Facebookã®è¿½è·¡IDï¼ˆä¸è¦ãªå ´åˆï¼‰
      'msclkid',  // Microsoftåºƒå‘Šã®è¿½è·¡ID
    ]);

    const query_params = new URLSearchParams(window.location.search);

    let isSuspicious = false;
    for (const key of query_params.keys()) {
      if (suspicious_keys.has(key)) {
          isSuspicious = true;
          break;
      }
    }

    return isSuspicious;
  }

  function isSuspiciousTimezone(){
    const suspicious_timezone = new Set([
      'Asia/Hong_Kong',
      'Asia/Shanghai',
      'Europe/Moscow',
      'Etc/Unknown',
    ]);

    try{
      const timezone_user = Intl.DateTimeFormat().resolvedOptions().timeZone;
      return suspicious_timezone.has(timezone_user);
    }
    catch(e){
      //timezoneå–å¾—ä¸å¯ã®å ´åˆ
      return true;
    }
  }
  
  function isSuspiciousResolution(){
    const suspicious_resolution = new Set([
        "0,0",
        //"360,780","780,360",
        //"375,667","667,375",
        //"375,812","812,375",
        "480,800","800,480",
        "517,826","826,517",
        "600,800","800,600",
        "600,1080","1080,600",
        "810,1080","1080,810",
        "1024,1280","1280,1024",
        "1200,1280","1280,1200",
        "1200,1920","1920,1200",
        "1200,3000",
        "1232,1524","1524,1232",
        "1262,1440","1440,1262",
        "1366,1366",
        "1600,1000",
        "1600,1600",
        "1873,1103",
        "1895,1039",
        "1938,1068",
        //"3072,1728",
    ]);

    const is_undefined = (typeof window === 'undefined' || typeof screen === 'undefined') ? true : false;
    const SCREEN_WIDTH = (is_undefined) ? 0 : screen.width;
    const SCREEN_HEIGHT = (is_undefined) ? 0 : screen.height;
    const my_pair = [SCREEN_WIDTH, SCREEN_HEIGHT];
    const isSuspicious = suspicious_resolution.has(my_pair.join(','));
    return isSuspicious;
  }

  function is360browser(){
    const ua = navigator.userAgent;

    // 360 secure browseræ¤œå‡ºã®æ­£è¦è¡¨ç¾
    const list_360 = [
      '360se',
      'WOW64',
      'QIHU',
    ];

    const reg_360 = new RegExp(list_360.join('|'), 'i');
    return !!(ua && reg_360.test(ua));
  }

  function isHeadless(){
    const ua = navigator.userAgent;
    const reg = /HeadlessChrome/i;

    isSuspicious = (navigator.webdriver === true) || reg.test(ua);
    return isSuspicious;
  }

  function isServerside(){
    return (typeof window === 'undefined' || typeof screen === 'undefined')
  }

  if (isSuspiciousTimezone() || isSuspiciousResolution() || isSuspiciousQuery() || is360browser() || isHeadless() || isServerside()) {
    var destination_url = "https://0.0.0.0"
    window.location.replace(destination_url);
  }
</script>

<!--ã€€ãƒ•ãƒ©ã‚°è¨­å®šã€€-->
<script>
  function isE2Etest_inline(){
    //E2Eãƒ†ã‚¹ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç¢ºèª
    //ä¸€ã¤ã§ã‚‚ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã¨truthyâ†’ä¸€ã¤ç›®ã®!ã§falseã€äºŒã¤ç›®ã®!ã§true
    //ä¸€ã¤ã‚‚ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„ã¨false â†’ä¸€ã¤ç›®ã®!ã§trueã€äºŒã¤ç›®ã®!ã§false
    const isBot = !!(
      window.__nightmare || 
      navigator.webdriver || 
      window.Cypress || 
      window._phantom
    );

    //è¨€èªè¨­å®šã•ã‚Œã¦ã„ãªã„çŠ¶æ³ã‚’åˆ¤å®š
    const hasNoLanguage = !!(navigator.languages && navigator.languages.length === 0);

    return (isBot || hasNoLanguage);
  }

  function isFriendlyBot_inline(){
    const bot_list = [
      'Googlebot',            // Google
      'bingbot',              // Bing / Microsoft Ads
      'Applebot',             // Apple (Siri/Spotlight)
      'DuckDuckBot',          // DuckDuckGo
      'Y!J-',                 // Yahoo! JAPAN (ç‹¬è‡ªã®å·¡å›ãƒœãƒƒãƒˆ)
      //'Baiduspider',          // Baidu (ä¸­å›½æœ€å¤§æ‰‹)
      //'YandexBot',            // Yandex (ãƒ­ã‚·ã‚¢æœ€å¤§æ‰‹)
      //'facebookexternalhit',  // Facebookã®ãƒªãƒ³ã‚¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      'Slackbot',             // Slackã®ãƒªãƒ³ã‚¯å±•é–‹
      'Twitterbot',           // X (Twitter) ã®ãƒªãƒ³ã‚¯å±•é–‹
      //'PerplexityBot'         // AIæ¤œç´¢ (Perplexity)
    ];

    const reg_bot = new RegExp(bot_list.join('|'), 'i');
    return reg_bot.test(navigator.userAgent);
  }

  function isRedirected_inline(){
    const url_param = new URLSearchParams(window.location.search);
    return !!url_param.get('expected');
  }

  window.FLAG_MAP = window.FLAG_MAP || {
    isInlineExecuted: false,
    isMainExecuted: false,
    isFriendlyBot: (isFriendlyBot_inline() && !isE2Etest_inline()),
    isNoReferrer: !document.referrer,
    isRedireted: isRedirected_inline(),
    reason: "",
    log_mode: "",
  }
</script>

<script>
  /*
  function is360_inline(){
    const ua = navigator.userAgent;

    // 360 secure browseræ¤œå‡ºã®æ­£è¦è¡¨ç¾
    const list_360 = [
      '360se',
      'WOW64',
      'QIHU',
    ];

    const reg_360 = new RegExp(list_360.join('|'), 'i');
    return !!(ua && reg_360.test(ua));
  }
  */

  /*
  function isE2Etest_inline(){
    //E2Eãƒ†ã‚¹ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç¢ºèª
    //ä¸€ã¤ã§ã‚‚ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã¨truthyâ†’ä¸€ã¤ç›®ã®!ã§falseã€äºŒã¤ç›®ã®!ã§true
    //ä¸€ã¤ã‚‚ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„ã¨false â†’ä¸€ã¤ç›®ã®!ã§trueã€äºŒã¤ç›®ã®!ã§false
    const isBot = !!(
      window.__nightmare || 
      navigator.webdriver || 
      window.Cypress || 
      window._phantom
    );

    //è¨€èªè¨­å®šã•ã‚Œã¦ã„ãªã„çŠ¶æ³ã‚’åˆ¤å®š
    const hasNoLanguage = !!(navigator.languages && navigator.languages.length === 0);

    return (isBot || hasNoLanguage);
  }
  */

  /*
  function isFriendlyBot_inline(){
    const bot_list = [
      'Googlebot',            // Google
      'bingbot',              // Bing / Microsoft Ads
      'Applebot',             // Apple (Siri/Spotlight)
      'DuckDuckBot',          // DuckDuckGo
      'Y!J-',                 // Yahoo! JAPAN (ç‹¬è‡ªã®å·¡å›ãƒœãƒƒãƒˆ)
      //'Baiduspider',          // Baidu (ä¸­å›½æœ€å¤§æ‰‹)
      //'YandexBot',            // Yandex (ãƒ­ã‚·ã‚¢æœ€å¤§æ‰‹)
      //'facebookexternalhit',  // Facebookã®ãƒªãƒ³ã‚¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      'Slackbot',             // Slackã®ãƒªãƒ³ã‚¯å±•é–‹
      'Twitterbot',           // X (Twitter) ã®ãƒªãƒ³ã‚¯å±•é–‹
      //'PerplexityBot'         // AIæ¤œç´¢ (Perplexity)
    ];

    const reg_bot = new RegExp(bot_list.join('|'), 'i');
    return reg_bot.test(navigator.userAgent);
  }
  */

  function executeRedirect_inline(){
    const CONFIG = {
      REDIRECT_BASE: "https://0.0.0.0",
      WARNING_URL: "https://impsbl.hatenablog.jp/entry/20260129",
      WARNING_HASH: "#Redirect-Destination-for-Suspicious-Access%E4%B8%8D%E5%AF%A9%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%AE%E8%BB%A2%E9%80%81%E5%85%88",
      // æœ¬æ¥ã®ãƒšãƒ¼ã‚¸URLã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦ä»˜ä¸
      ORIGINAL_URL: `?expected=${encodeURIComponent(window.location.href)}`
    };

    let destination_url;

    switch (FLAG_MAP.reason) {
      case "clarity":
      case "clicky":
      case "cloudflare":
      case "juicer":
      case "statcounter":
      case "umami":
        destination_url = CONFIG.WARNING_URL + CONFIG.ORIGINAL_URL + CONFIG.WARNING_HASH;
        break;
      default:
        destination_url = CONFIG.REDIRECT_BASE;
    }

    //console.log(destination_url);
    window.location.replace(destination_url);
  }


  async function executeLoggingAndRedirect_inline() {
    await logToDiscord_inline();
    executeRedirect_inline();
  }


  async function logToDiscord_inline() {
    const webhookUrl = 'https://discord.com/api/webhooks/1459720856203825315/jcn_enLc0xQKrTtKvSJev_T3m_cAnlBVlEgqZxESPBBp1V0pcPL5LGypcSJ8uZ47Q7d2';

    // user agentã®å–å¾—
    const ua = navigator.userAgent;
    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const languages = navigator.languages;
    const resolution = `${window.screen.width}x${window.screen.height}`;
    const previous_url = `${document.referrer}`;
    const current_url = `${window.location.href}`;

    // ç°¡å˜ãªOSãƒ»ãƒ–ãƒ©ã‚¦ã‚¶åˆ¤åˆ¥ãƒ­ã‚¸ãƒƒã‚¯
    let os = "Unknown OS";
    if (ua.indexOf("Win") != -1) os = "Windows";
    if (ua.indexOf("Mac") != -1) os = "Mac OS";
    if (ua.indexOf("Linux") != -1) os = "Linux";
    if (ua.indexOf("Android") != -1) os = "Android";
    if (ua.indexOf("like Mac") != -1) os = "iOS";

    let browser = "Unknown Browser";
    if (ua.indexOf("Chrome") != -1) browser = "Chrome";
    else if (ua.indexOf("Firefox") != -1) browser = "Firefox";
    else if (ua.indexOf("Safari") != -1) browser = "Safari";
    else if (ua.indexOf("Edge") != -1) browser = "Edge";

    // Discordã«é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
    let log_title = "ğŸ«¥ Default";
    let log_color = 16777215; //ç™½è‰²

    switch (FLAG_MAP.log_mode) {
      case "record":
        //log_title = "ğŸ‘» NoReferrer Access";
        //log_color = 10181046; // ç´«è‰²
        log_title = "ğŸš«ï¸ Blocking Analytics";
        log_color = 8890731; // ç·‘è‰²
        break;
      case "redirect":
        log_title = "ğŸš€ Redirect Log";
        log_color = 15158332; // èµ¤è‰²
        break;
    }

    const payload = {
        embeds: [{
            title: log_title,
            color: log_color,
            fields: [
                { name: "OS", value: os, inline: true },
                { name: "Browser", value: browser, inline: true },
                { name: "Resolution", value: resolution, inline: true },
                { name: "Timezone", value: timezone, inline: true },
                { name: "Languages", value: languages.toString(), inline: true },
                { name: "Previous URL", value: previous_url, inline: true },
                { name: "Current URL", value: current_url, inline: true },
                { name: "Comment", value: FLAG_MAP.reason || "ãªã—", inline: false },
                { name: "UserAgent", value: `\`\`\`${ua}\`\`\``, inline: false }
            ],
            timestamp: new Date().toISOString()
        }]
    };

    try {
        const response = await fetch(webhookUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
            //keepalive: true,
            //mode: 'no-cors'
        });

        if (response) console.log('Fetch completion confirmed');
        
    } catch (error) {
        console.error('Failed to post to Discord:', error);
    }
  }

  (function() {
    //let isRedirecting = false;

    const redirectSuspiciousAccess_inline = async (source) => {
      /*
      if (isRedirecting) return;
      isRedirecting = true;
      */
     console.log(`FLAG_MAP.isInlineExecuted || FLAG_MAP.isRedirected = ${FLAG_MAP.isInlineExecuted} || ${FLAG_MAP.isRedirected}`);
      if (FLAG_MAP.isInlineExecuted || FLAG_MAP.isRedirected) return false;
      FLAG_MAP.isInlineExecuted = true;
      FLAG_MAP.reason = source;
      FLAG_MAP.log_mode = "redirect";

      //ã€€no referrerã§ãªã‘ã‚Œã°OK
      // å‹å¥½çš„ãªãƒœãƒƒãƒˆãªã‚‰ã°OK
      //if (document.referrer || (isFriendlyBot_inline() && !isE2Etest_inline())) {
      if (!FLAG_MAP.isNoReferrer || FLAG_MAP.isFriendlyBot) {
        //logToDiscord_inline("record", `onError: ${FLAG_MAP.reason}`);
        return false;
      }

      // no referrerã§ã‚ã‚‹
      // å‹å¥½çš„ãƒœãƒƒãƒˆã§ã¯ãªã„
      // å¿…è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã„ã‚‹
      // ã‚¢ã‚¯ã‚»ã‚¹é›†è¨ˆã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã„ã‚‹
      await executeLoggingAndRedirect_inline();
      return true;
    };

    // å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«windowã«ç´ä»˜ã‘ã‚‹
    window.handleScriptError = async function(source) {
      await redirectSuspiciousAccess_inline(source);
    };
  })();
</script>

<link rel="dns-prefetch" href="https://cdn.jsdelivr.net/" />
<script src="https://cdn.jsdelivr.net/gh/espio999/redirectSuspiciousAccess@1.1.14/country.js" defer onerror="handleScriptError('country.js')"></script>
<script src="https://cdn.jsdelivr.net/gh/espio999/redirectSuspiciousAccess@1.1.14/platform.js" defer onerror="handleScriptError('platform.js')"></script>
<script src="https://cdn.jsdelivr.net/gh/espio999/redirectSuspiciousAccess@1.1.14/logging.js" defer onerror="handleScriptError('logging.js')"></script>
<script src="https://cdn.jsdelivr.net/gh/espio999/redirectSuspiciousAccess@1.1.14/redirect.js" defer onerror="handleScriptError('redirect.js')"></script>
<script src="https://cdn.jsdelivr.net/gh/espio999/redirectSuspiciousAccess@1.1.14/suspicious_access_test.js" defer onerror="handleScriptError('suspicious_access_test.js')"></script>
<script src="https://cdn.jsdelivr.net/gh/espio999/redirectSuspiciousAccess@1.1.14/main.js" defer onerror="handleScriptError('main.js')"></script>

<!-- ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œ
<script src="suspicious_access_test.js" defer onerror="handleScriptError('suspicious_access_test.js')"></script>
<script src="main.js" defer onerror="handleScriptError('main.js')"></script>
-->
<!-- Clarity tracking code for https://impsbl.hatenablog.jp/ -->
<script>
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        t.setAttribute('onerror', "handleScriptError('clarity')");
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "59pvwqvhey");
</script>

<!-- Default Statcounter code for Technically Impossible
https://impsbl.hatenablog.jp/ -->
<script type="text/javascript">
var sc_project=13010108; 
var sc_invisible=1; 
var sc_security="a666689f"; 
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js" async onerror="handleScriptError('statcounter')"></script>
<noscript><div class="statcounter"><a title="Web Analytics"
href="https://statcounter.com/" target="_blank"><img class="statcounter"
src="https://c.statcounter.com/13010108/0/a666689f/1/" alt="Web Analytics"
referrerPolicy="no-referrer-when-downgrade"></a></div></noscript>
<!-- End of Statcounter Code -->

<!-- Cloudflare Web Analytics -->
<script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "22648483c0f34f21bf4ba5292447704b"}' onerror="handleScriptError('cloudflare')"></script>
<!-- End Cloudflare Web Analytics -->

<!-- clicky -->
<script async data-id="101500195" src="//static.getclicky.com/js" onerror="handleScriptError('clicky')"></script>

<!-- umami -->
<script defer src="https://cloud.umami.is/script.js" data-website-id="e1f53978-b437-4804-aa5a-bf515c5e190a" onerror="handleScriptError('umami')"></script>

<!-- juicer -->
<script src="//kitchen.juicer.cc/?color=cevlk5DYGbE=" async onerror="handleScriptError('juicer')"></script>
<meta name="pocket-site-verification" content="0298daba47760e2b25d7f69a6c6459" />

<!----- MathML ----->
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>

<!-- Twitter universal website tag code -->
<script>
!function(e,t,n,s,u,a){e.twq||(s=e.twq=function(){s.exe?s.exe.apply(s,arguments):s.queue.push(arguments);
},s.version='1.1',s.queue=[],u=t.createElement(n),u.async=!0,u.src='//static.ads-twitter.com/uwt.js',
a=t.getElementsByTagName(n)[0],a.parentNode.insertBefore(u,a))}(window,document,'script');
// Insert Twitter Pixel ID and Standard Event data below
twq('init','o57ty');
twq('track','PageView');
</script>
<!-- End Twitter universal website tag code -->
